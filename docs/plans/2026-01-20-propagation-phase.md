# Propagation Phase Implementation Plan

> **For Claude:** REQUIRED SUB-SKILL: Use superpowers:executing-plans to implement this plan task-by-task.

**Goal:** Add the Propagation phase (Activated Platelet panel) with Tenase and Prothrombinase complex assembly, completing the cell-based coagulation model.

**Architecture:** Extend existing three-panel layout. Add FIX factor, circulation tray for held enzymes, auto-transfer cofactors on phase transition, Tenase spawns new FXa token, Prothrombinase produces thrombin burst. Victory at 100% thrombin.

**Tech Stack:** Next.js 16, React 19, TypeScript, existing game infrastructure

---

## Task 1: Update Types

**Files:**
- Modify: `types/game.ts`

**Step 1: Add new types for circulation and complexes**

Add to `types/game.ts`:

```typescript
// Add to existing types

export type ComplexType = 'tenase' | 'prothrombinase';

export interface ComplexSlot {
  id: string;
  complexType: ComplexType;
  role: 'enzyme' | 'cofactor';
  acceptsFactorId: string;
  placedFactorId: string | null;
  isAutoFilled: boolean; // cofactors auto-fill on phase transition
}

// Update GameState interface - add these fields:
export interface GameState {
  phase: GamePhase;
  thrombinMeter: number;
  slots: Slot[];
  complexSlots: ComplexSlot[]; // NEW: activated platelet complex slots
  circulationFactors: string[]; // NEW: factors "in circulation" (FIXa held here)
  availableFactors: string[];
  selectedFactorId: string | null;
  currentMessage: string;
  isError: boolean;
}

// Update GameAction - add new actions:
export type GameAction =
  | { type: 'SELECT_FACTOR'; factorId: string }
  | { type: 'DESELECT_FACTOR' }
  | { type: 'ATTEMPT_PLACE'; slotId: string }
  | { type: 'ATTEMPT_COMPLEX_PLACE'; complexSlotId: string } // NEW
  | { type: 'RESET_GAME' };
```

**Step 2: Verify TypeScript compiles**

Run: `npx tsc --noEmit types/game.ts 2>&1 | head -10`

**Step 3: Commit**

```bash
git add types/game.ts
git commit -m "feat(types): add ComplexSlot and circulation types for propagation"
```

---

## Task 2: Update Factor Definitions

**Files:**
- Modify: `engine/game/factor-definitions.ts`

**Step 1: Add FIX factor and update thrombin contributions**

Update `FACTOR_DEFINITIONS`:

```typescript
export const FACTOR_DEFINITIONS: Record<string, FactorDefinition> = {
  FX: {
    id: 'FX',
    inactiveLabel: 'FX',
    activeLabel: 'FXa',
    category: 'zymogen',
    targetSurface: 'tf-cell',
    activationMessage: 'FXa generated on TF-cell surface (TF+VIIa catalyzes)',
    errorMessageWrongSlot: 'FX must be placed on TF-bearing cell where TF+VIIa can activate it.',
    prerequisites: [],
    thrombinContribution: 0, // CHANGED from 5 to 0
    color: '#3B82F6',
  },
  FIX: {
    id: 'FIX',
    inactiveLabel: 'FIX',
    activeLabel: 'FIXa',
    category: 'zymogen',
    targetSurface: 'tf-cell',
    activationMessage: 'FIXa generated on TF-cell (TF+VIIa catalyzes). Held in circulation.',
    errorMessageWrongSlot: 'FIX must be placed on TF-bearing cell where TF+VIIa can activate it.',
    prerequisites: [],
    thrombinContribution: 0,
    color: '#06B6D4', // cyan
  },
  FII: {
    id: 'FII',
    inactiveLabel: 'FII',
    activeLabel: 'THR',
    category: 'zymogen',
    targetSurface: 'tf-cell',
    activationMessage: 'Starter thrombin via Xa + trace Va (initiation scaffold)',
    errorMessageWrongSlot: 'FII must be placed on TF-bearing cell where FXa + Va can generate thrombin.',
    prerequisites: ['FX'],
    thrombinContribution: 30, // CHANGED from 25 to 30
    color: '#EF4444',
  },
  FV: {
    id: 'FV',
    inactiveLabel: 'FV',
    activeLabel: 'FVa',
    category: 'procofactor',
    targetSurface: 'platelet',
    activationMessage: 'FVa activated on platelet surface (thrombin cleaves)',
    errorMessageWrongSlot: 'FV must be placed on activated platelet surface.',
    prerequisites: [],
    thrombinContribution: 0,
    color: '#8B5CF6',
  },
  FVIII: {
    id: 'FVIII',
    inactiveLabel: 'FVIII+vWF',
    activeLabel: 'FVIIIa',
    category: 'procofactor',
    targetSurface: 'platelet',
    activationMessage: 'FVIIIa activated, dissociates from vWF (thrombin cleaves)',
    errorMessageWrongSlot: 'FVIII must be placed on activated platelet surface.',
    prerequisites: [],
    thrombinContribution: 0,
    color: '#EC4899',
  },
  // Special: Tenase-generated FXa (not in palette, spawned by Tenase)
  'FXa-tenase': {
    id: 'FXa-tenase',
    inactiveLabel: 'FXa',
    activeLabel: 'FXa',
    category: 'enzyme',
    targetSurface: 'activated-platelet',
    activationMessage: 'FXa (generated by Tenase on activated platelet)',
    errorMessageWrongSlot: 'This FXa docks into Prothrombinase.',
    prerequisites: [],
    thrombinContribution: 0,
    color: '#3B82F6',
  },
} as const;
```

**Step 2: Commit**

```bash
git add engine/game/factor-definitions.ts
git commit -m "feat(factors): add FIX, update thrombin contributions for propagation"
```

---

## Task 3: Update Game Config

**Files:**
- Modify: `engine/game/game-config.ts`

**Step 1: Add complex slots and circulation tray layout**

Add after existing slot definitions:

```typescript
// =============================================================================
// COMPLEX SLOTS (Activated Platelet)
// =============================================================================

export interface ComplexSlotPosition {
  slotId: string;
  x: number;
  y: number;
  width: number;
  height: number;
}

export function createInitialComplexSlots(): ComplexSlot[] {
  return [
    // Tenase complex
    {
      id: 'tenase-enzyme',
      complexType: 'tenase',
      role: 'enzyme',
      acceptsFactorId: 'FIXa',
      placedFactorId: null,
      isAutoFilled: false,
    },
    {
      id: 'tenase-cofactor',
      complexType: 'tenase',
      role: 'cofactor',
      acceptsFactorId: 'FVIIIa',
      placedFactorId: null,
      isAutoFilled: true, // auto-fills when propagation unlocks
    },
    // Prothrombinase complex
    {
      id: 'prothrombinase-enzyme',
      complexType: 'prothrombinase',
      role: 'enzyme',
      acceptsFactorId: 'FXa-tenase',
      placedFactorId: null,
      isAutoFilled: false,
    },
    {
      id: 'prothrombinase-cofactor',
      complexType: 'prothrombinase',
      role: 'cofactor',
      acceptsFactorId: 'FVa',
      placedFactorId: null,
      isAutoFilled: true, // auto-fills when propagation unlocks
    },
  ];
}

export const COMPLEX_SLOT_POSITIONS: Record<string, ComplexSlotPosition> = {
  'tenase-cofactor': { slotId: 'tenase-cofactor', x: 30, y: 100, width: 100, height: 60 },
  'tenase-enzyme': { slotId: 'tenase-enzyme', x: 140, y: 100, width: 100, height: 60 },
  'prothrombinase-cofactor': { slotId: 'prothrombinase-cofactor', x: 30, y: 220, width: 100, height: 60 },
  'prothrombinase-enzyme': { slotId: 'prothrombinase-enzyme', x: 140, y: 220, width: 100, height: 60 },
} as const;

// =============================================================================
// COMPLEX LABELS
// =============================================================================

export const COMPLEX_LABELS = {
  tenase: { name: 'TENASE', output: 'FXa' },
  prothrombinase: { name: 'PROTHROMBINASE', output: 'Thrombin Burst' },
} as const;
```

**Step 2: Add FIX slot to TF-cell**

Update `createInitialSlots()`:

```typescript
export function createInitialSlots(): Slot[] {
  return [
    // TF-cell slots (Initiation)
    {
      id: 'tf-cell-fx',
      surface: 'tf-cell',
      acceptsFactorId: 'FX',
      isLocked: false,
      placedFactorId: null,
      isActive: false,
    },
    {
      id: 'tf-cell-fix',
      surface: 'tf-cell',
      acceptsFactorId: 'FIX',
      isLocked: false,
      placedFactorId: null,
      isActive: false,
    },
    {
      id: 'tf-cell-fii',
      surface: 'tf-cell',
      acceptsFactorId: 'FII',
      isLocked: false,
      placedFactorId: null,
      isActive: false,
    },
    // Platelet slots (Amplification)
    {
      id: 'platelet-fv',
      surface: 'platelet',
      acceptsFactorId: 'FV',
      isLocked: true,
      placedFactorId: null,
      isActive: false,
    },
    {
      id: 'platelet-fviii',
      surface: 'platelet',
      acceptsFactorId: 'FVIII',
      isLocked: true,
      placedFactorId: null,
      isActive: false,
    },
  ];
}
```

**Step 3: Update SLOT_POSITIONS for new FIX slot**

```typescript
export const SLOT_POSITIONS: Record<string, SlotPosition> = {
  'tf-cell-fx': { slotId: 'tf-cell-fx', x: 40, y: 180, width: 100, height: 70 },
  'tf-cell-fix': { slotId: 'tf-cell-fix', x: 160, y: 180, width: 100, height: 70 },
  'tf-cell-fii': { slotId: 'tf-cell-fii', x: 100, y: 280, width: 100, height: 70 },
  'platelet-fv': { slotId: 'platelet-fv', x: 60, y: 180, width: 120, height: 80 },
  'platelet-fviii': { slotId: 'platelet-fviii', x: 60, y: 280, width: 140, height: 80 },
} as const;
```

**Step 4: Update activated-platelet panel config**

Change `isComingSoon: true` to `isComingSoon: false` in PANEL_CONFIGS for activated-platelet.

**Step 5: Commit**

```bash
git add engine/game/game-config.ts
git commit -m "feat(config): add complex slots, FIX slot, enable activated platelet panel"
```

---

## Task 4: Update Validation Rules

**Files:**
- Modify: `engine/game/validation-rules.ts`

**Step 1: Update victory condition and add complex validation**

```typescript
// Update checkVictoryCondition
export function checkVictoryCondition(state: GameState): boolean {
  // Victory when Prothrombinase is complete (thrombin = 100%)
  const prothrombinaseComplete = state.complexSlots
    .filter((s) => s.complexType === 'prothrombinase')
    .every((s) => s.placedFactorId !== null);

  return state.thrombinMeter >= 100 && prothrombinaseComplete;
}

// Add new function: check if amplification is complete
export function isAmplificationComplete(state: GameState): boolean {
  const fvPlaced = state.slots.some(
    (s) => s.placedFactorId === 'FV' && s.isActive
  );
  const fviiiPlaced = state.slots.some(
    (s) => s.placedFactorId === 'FVIII' && s.isActive
  );
  return fvPlaced && fviiiPlaced;
}

// Add new function: check if Tenase is complete
export function isTenaseComplete(state: GameState): boolean {
  return state.complexSlots
    .filter((s) => s.complexType === 'tenase')
    .every((s) => s.placedFactorId !== null);
}

// Add new function: validate complex slot placement
export function validateComplexPlacement(
  state: GameState,
  factorId: string,
  complexSlotId: string
): ValidationResult {
  const complexSlot = state.complexSlots.find((s) => s.id === complexSlotId);
  if (!complexSlot) {
    return { isValid: false, errorMessage: `Unknown complex slot: ${complexSlotId}` };
  }

  // Check if slot is already filled
  if (complexSlot.placedFactorId !== null) {
    return { isValid: false, errorMessage: 'This complex slot is already filled.' };
  }

  // Check if factor matches what slot accepts
  // For enzyme slots, check the active form
  const expectedFactor = complexSlot.acceptsFactorId;
  if (factorId !== expectedFactor && `${factorId}a` !== expectedFactor) {
    return {
      isValid: false,
      errorMessage: `This slot requires ${expectedFactor}.`
    };
  }

  // For prothrombinase enzyme slot, Tenase must be complete first
  if (complexSlot.id === 'prothrombinase-enzyme' && !isTenaseComplete(state)) {
    return {
      isValid: false,
      errorMessage: 'Complete Tenase first to generate FXa for Prothrombinase.'
    };
  }

  return { isValid: true, errorMessage: null };
}
```

**Step 2: Commit**

```bash
git add engine/game/validation-rules.ts
git commit -m "feat(validation): add complex validation, update victory condition"
```

---

## Task 5: Update useGameState Hook

**Files:**
- Modify: `hooks/useGameState.ts`

**Step 1: Update initial state and reducer**

This is the largest change. Update the entire hook:

```typescript
// hooks/useGameState.ts
'use client';

import { useReducer, useCallback } from 'react';
import type { GameState, GameAction, Slot, ComplexSlot } from '@/types/game';
import { createInitialSlots, createInitialComplexSlots } from '@/engine/game/game-config';
import { getAllFactorIds, getFactorDefinition } from '@/engine/game/factor-definitions';
import {
  validatePlacement,
  validateComplexPlacement,
  shouldUnlockPlatelet,
  checkVictoryCondition,
  isAmplificationComplete,
  isTenaseComplete,
  THROMBIN_STARTER_THRESHOLD,
} from '@/engine/game/validation-rules';

// =============================================================================
// INITIAL STATE
// =============================================================================

function createInitialState(): GameState {
  return {
    phase: 'initiation',
    thrombinMeter: 0,
    slots: createInitialSlots(),
    complexSlots: createInitialComplexSlots(),
    circulationFactors: [], // FIXa will be added here after placement
    availableFactors: getAllFactorIds().filter(id => id !== 'FXa-tenase'), // exclude special token
    selectedFactorId: null,
    currentMessage: 'Place factors on the TF-bearing cell to begin initiation.',
    isError: false,
  };
}

// =============================================================================
// REDUCER
// =============================================================================

function gameReducer(state: GameState, action: GameAction): GameState {
  switch (action.type) {
    case 'SELECT_FACTOR': {
      // Can select from palette, circulation, or tenase-spawned
      const inPalette = state.availableFactors.includes(action.factorId);
      const inCirculation = state.circulationFactors.includes(action.factorId);
      const isTenaseXa = action.factorId === 'FXa-tenase' &&
        isTenaseComplete(state) &&
        !state.complexSlots.find(s => s.id === 'prothrombinase-enzyme')?.placedFactorId;

      if (!inPalette && !inCirculation && !isTenaseXa) {
        return state;
      }

      if (state.selectedFactorId === action.factorId) {
        return {
          ...state,
          selectedFactorId: null,
          currentMessage: 'Selection cleared.',
          isError: false,
        };
      }

      const factor = getFactorDefinition(action.factorId);
      return {
        ...state,
        selectedFactorId: action.factorId,
        currentMessage: `${factor?.activeLabel || factor?.inactiveLabel} selected. Click a valid slot.`,
        isError: false,
      };
    }

    case 'DESELECT_FACTOR': {
      return {
        ...state,
        selectedFactorId: null,
        currentMessage: 'Selection cleared.',
        isError: false,
      };
    }

    case 'ATTEMPT_PLACE': {
      if (!state.selectedFactorId) {
        return { ...state, currentMessage: 'Select a factor first.', isError: true };
      }

      const factorId = state.selectedFactorId;
      const validation = validatePlacement(state, factorId, action.slotId);

      if (!validation.isValid) {
        return { ...state, currentMessage: validation.errorMessage ?? 'Invalid placement.', isError: true };
      }

      const factor = getFactorDefinition(factorId)!;
      let newSlots: Slot[] = state.slots.map((slot) =>
        slot.id === action.slotId
          ? { ...slot, placedFactorId: factorId, isActive: true }
          : slot
      );

      const newThrombinMeter = Math.min(100, state.thrombinMeter + factor.thrombinContribution);

      // Unlock platelet if threshold crossed
      if (shouldUnlockPlatelet(newThrombinMeter) && !shouldUnlockPlatelet(state.thrombinMeter)) {
        newSlots = newSlots.map((slot) =>
          slot.surface === 'platelet' ? { ...slot, isLocked: false } : slot
        );
      }

      let newAvailableFactors = state.availableFactors.filter((f) => f !== factorId);
      let newCirculationFactors = [...state.circulationFactors];
      let newMessage = factor.activationMessage;
      let newPhase = state.phase;

      // If FIX was placed, add FIXa to circulation
      if (factorId === 'FIX') {
        newCirculationFactors.push('FIXa');
        newMessage = 'FIXa generated and held in circulation (available for Tenase).';
      }

      // Check if platelet just unlocked
      if (shouldUnlockPlatelet(newThrombinMeter) && !shouldUnlockPlatelet(state.thrombinMeter)) {
        newMessage = 'Starter thrombin activates platelet via PAR receptors. Amplification begins.';
        newPhase = 'amplification';
      }

      // Build intermediate state
      let intermediateState: GameState = {
        ...state,
        phase: newPhase,
        thrombinMeter: newThrombinMeter,
        slots: newSlots,
        complexSlots: state.complexSlots,
        circulationFactors: newCirculationFactors,
        availableFactors: newAvailableFactors,
        selectedFactorId: null,
        currentMessage: newMessage,
        isError: false,
      };

      // Check if amplification just completed - auto-fill cofactors and transition
      if (isAmplificationComplete(intermediateState) && state.phase === 'amplification') {
        const newComplexSlots = intermediateState.complexSlots.map((cs) => {
          if (cs.id === 'tenase-cofactor') {
            return { ...cs, placedFactorId: 'FVIIIa' };
          }
          if (cs.id === 'prothrombinase-cofactor') {
            return { ...cs, placedFactorId: 'FVa' };
          }
          return cs;
        });

        intermediateState = {
          ...intermediateState,
          phase: 'propagation',
          complexSlots: newComplexSlots,
          currentMessage: 'Cofactors positioned on activated platelet. Dock enzymes to complete complexes.',
        };
      }

      return intermediateState;
    }

    case 'ATTEMPT_COMPLEX_PLACE': {
      if (!state.selectedFactorId) {
        return { ...state, currentMessage: 'Select a factor first.', isError: true };
      }

      const factorId = state.selectedFactorId;
      const validation = validateComplexPlacement(state, factorId, action.complexSlotId);

      if (!validation.isValid) {
        return { ...state, currentMessage: validation.errorMessage ?? 'Invalid placement.', isError: true };
      }

      const complexSlot = state.complexSlots.find((s) => s.id === action.complexSlotId)!;
      let newComplexSlots = state.complexSlots.map((cs) =>
        cs.id === action.complexSlotId
          ? { ...cs, placedFactorId: factorId }
          : cs
      );

      let newCirculationFactors = state.circulationFactors.filter((f) => f !== factorId);
      let newThrombinMeter = state.thrombinMeter;
      let newMessage = '';

      // Build intermediate state to check Tenase completion
      let intermediateState: GameState = {
        ...state,
        complexSlots: newComplexSlots,
        circulationFactors: newCirculationFactors,
        selectedFactorId: null,
        isError: false,
        currentMessage: '',
        thrombinMeter: newThrombinMeter,
      };

      // If Tenase just completed, spawn FXa-tenase
      if (complexSlot.complexType === 'tenase' && isTenaseComplete(intermediateState)) {
        newMessage = 'Tenase complete! FXa generated on activated platelet. Dock into Prothrombinase.';
        // FXa-tenase becomes available (handled via isTenaseComplete check in SELECT_FACTOR)
      }

      // If Prothrombinase enzyme slot filled, add thrombin burst
      if (complexSlot.id === 'prothrombinase-enzyme') {
        newThrombinMeter = 100;
        newMessage = 'Prothrombinase complete! Thrombin burst generated.';
      }

      intermediateState = {
        ...intermediateState,
        thrombinMeter: newThrombinMeter,
        currentMessage: newMessage || `${factorId} docked into ${complexSlot.complexType}.`,
      };

      // Check victory
      if (checkVictoryCondition(intermediateState)) {
        return {
          ...intermediateState,
          phase: 'complete',
          currentMessage: 'Thrombin burst achieved! Coagulation cascade complete.',
        };
      }

      return intermediateState;
    }

    case 'RESET_GAME': {
      return createInitialState();
    }

    default:
      return state;
  }
}

// =============================================================================
// HOOK
// =============================================================================

export interface UseGameStateReturn {
  state: GameState;
  selectFactor: (factorId: string) => void;
  deselectFactor: () => void;
  attemptPlace: (slotId: string) => void;
  attemptComplexPlace: (complexSlotId: string) => void;
  resetGame: () => void;
}

export function useGameState(): UseGameStateReturn {
  const [state, dispatch] = useReducer(gameReducer, null, createInitialState);

  const selectFactor = useCallback((factorId: string) => {
    dispatch({ type: 'SELECT_FACTOR', factorId });
  }, []);

  const deselectFactor = useCallback(() => {
    dispatch({ type: 'DESELECT_FACTOR' });
  }, []);

  const attemptPlace = useCallback((slotId: string) => {
    dispatch({ type: 'ATTEMPT_PLACE', slotId });
  }, []);

  const attemptComplexPlace = useCallback((complexSlotId: string) => {
    dispatch({ type: 'ATTEMPT_COMPLEX_PLACE', complexSlotId });
  }, []);

  const resetGame = useCallback(() => {
    dispatch({ type: 'RESET_GAME' });
  }, []);

  return {
    state,
    selectFactor,
    deselectFactor,
    attemptPlace,
    attemptComplexPlace,
    resetGame,
  };
}
```

**Step 2: Commit**

```bash
git add hooks/useGameState.ts
git commit -m "feat(state): add complex placement, auto-transfer, Tenase spawning"
```

---

## Task 6: Create CirculationTray Component

**Files:**
- Create: `components/game/CirculationTray.tsx`

**Step 1: Create the component**

```typescript
// components/game/CirculationTray.tsx
'use client';

import { COLORS } from '@/engine/game/game-config';
import { getFactorDefinition } from '@/engine/game/factor-definitions';
import { FactorToken } from './FactorToken';
import type { GameState } from '@/types/game';
import { isTenaseComplete } from '@/engine/game/validation-rules';

interface CirculationTrayProps {
  circulationFactors: string[];
  selectedFactorId: string | null;
  gameState: GameState;
  onFactorClick: (factorId: string) => void;
}

export function CirculationTray({
  circulationFactors,
  selectedFactorId,
  gameState,
  onFactorClick,
}: CirculationTrayProps): React.ReactElement | null {
  // Show Tenase-spawned FXa if Tenase is complete and not yet docked
  const tenaseComplete = isTenaseComplete(gameState);
  const fxaTenaseDocked = gameState.complexSlots
    .find((s) => s.id === 'prothrombinase-enzyme')?.placedFactorId === 'FXa-tenase';
  const showTenaseXa = tenaseComplete && !fxaTenaseDocked;

  const allCirculationItems = [
    ...circulationFactors,
    ...(showTenaseXa ? ['FXa-tenase'] : []),
  ];

  if (allCirculationItems.length === 0) {
    return null;
  }

  return (
    <div
      style={{
        position: 'absolute',
        top: 80,
        right: 16,
        width: 120,
        padding: 12,
        backgroundColor: COLORS.panelBackgroundLocked,
        border: `1px solid ${COLORS.panelBorder}`,
        borderRadius: 8,
        zIndex: 10,
      }}
    >
      <div
        style={{
          fontSize: 10,
          fontWeight: 600,
          color: COLORS.textSecondary,
          textTransform: 'uppercase',
          marginBottom: 8,
          textAlign: 'center',
        }}
      >
        In Circulation
      </div>
      <div style={{ display: 'flex', flexDirection: 'column', gap: 8 }}>
        {allCirculationItems.map((factorId) => {
          const factor = getFactorDefinition(factorId);
          if (!factor) return null;

          const isAvailable = gameState.phase === 'propagation';

          return (
            <div
              key={factorId}
              style={{
                opacity: isAvailable ? 1 : 0.5,
                cursor: isAvailable ? 'pointer' : 'not-allowed',
              }}
              onClick={() => isAvailable && onFactorClick(factorId)}
            >
              <FactorToken
                factor={factor}
                isActive={true}
                isSelected={selectedFactorId === factorId}
                style={{
                  minWidth: 'auto',
                  padding: '4px 8px',
                  fontSize: 12,
                }}
              />
            </div>
          );
        })}
      </div>
      {gameState.phase !== 'propagation' && circulationFactors.length > 0 && (
        <div
          style={{
            fontSize: 9,
            color: COLORS.textDim,
            textAlign: 'center',
            marginTop: 8,
          }}
        >
          Available after amplification
        </div>
      )}
    </div>
  );
}
```

**Step 2: Commit**

```bash
git add components/game/CirculationTray.tsx
git commit -m "feat(components): add CirculationTray for held enzymes"
```

---

## Task 7: Update SurfacePanel for Complex Slots

**Files:**
- Modify: `components/game/SurfacePanel.tsx`

**Step 1: Add complex slot rendering**

Add complex slots rendering for activated-platelet surface. Update imports and add new rendering logic:

```typescript
// Add to imports
import type { ComplexSlot } from '@/types/game';
import { COMPLEX_SLOT_POSITIONS, COMPLEX_LABELS } from '@/engine/game/game-config';
import { isTenaseComplete } from '@/engine/game/validation-rules';

// Update props interface
interface SurfacePanelProps {
  config: PanelConfig;
  slots: Slot[];
  complexSlots: ComplexSlot[];
  gameState: GameState;
  onSlotClick: (slotId: string) => void;
  onComplexSlotClick: (complexSlotId: string) => void;
}

// Inside the component, after the regular slots rendering, add:

{/* Complex Slots for Activated Platelet */}
{config.surface === 'activated-platelet' && !config.isComingSoon && (
  <>
    {/* Tenase label */}
    <div
      style={{
        position: 'absolute',
        left: 30,
        top: 70,
        fontSize: 12,
        fontWeight: 700,
        color: COLORS.textSecondary,
      }}
    >
      {COMPLEX_LABELS.tenase.name}
    </div>

    {/* Prothrombinase label */}
    <div
      style={{
        position: 'absolute',
        left: 30,
        top: 190,
        fontSize: 12,
        fontWeight: 700,
        color: COLORS.textSecondary,
      }}
    >
      {COMPLEX_LABELS.prothrombinase.name}
    </div>

    {/* Complex slots */}
    {complexSlots.map((complexSlot) => {
      const pos = COMPLEX_SLOT_POSITIONS[complexSlot.id];
      if (!pos) return null;

      const placedFactor = complexSlot.placedFactorId
        ? getFactorDefinition(complexSlot.placedFactorId)
        : null;

      const isEnzymeSlot = complexSlot.role === 'enzyme';
      const isClickable = isEnzymeSlot && !complexSlot.placedFactorId;

      // For prothrombinase enzyme, need Tenase complete first
      const needsTenase = complexSlot.id === 'prothrombinase-enzyme' && !isTenaseComplete(gameState);

      return (
        <div
          key={complexSlot.id}
          onClick={() => isClickable && !needsTenase && onComplexSlotClick(complexSlot.id)}
          style={{
            position: 'absolute',
            left: pos.x,
            top: pos.y,
            width: pos.width,
            height: pos.height,
            backgroundColor: complexSlot.isAutoFilled
              ? `${COLORS.slotBackground}80`
              : COLORS.slotBackground,
            border: `2px ${complexSlot.isAutoFilled ? 'solid' : 'dashed'} ${
              needsTenase ? COLORS.textDim : COLORS.panelBorder
            }`,
            borderRadius: 8,
            display: 'flex',
            alignItems: 'center',
            justifyContent: 'center',
            cursor: isClickable && !needsTenase ? 'pointer' : 'default',
          }}
        >
          {placedFactor ? (
            <FactorToken
              factor={placedFactor}
              isActive={true}
              style={{ minWidth: 'auto', padding: '4px 8px' }}
            />
          ) : (
            <span style={{ fontSize: 10, color: COLORS.textDim }}>
              {complexSlot.role === 'enzyme' ? 'enzyme' : 'cofactor'}
            </span>
          )}
        </div>
      );
    })}
  </>
)}
```

**Step 2: Commit**

```bash
git add components/game/SurfacePanel.tsx
git commit -m "feat(components): add complex slot rendering for activated platelet"
```

---

## Task 8: Update GameCanvas

**Files:**
- Modify: `components/game/GameCanvas.tsx`

**Step 1: Add CirculationTray and pass new props**

```typescript
// Add import
import { CirculationTray } from './CirculationTray';

// Update props interface
interface GameCanvasProps {
  gameState: GameState;
  onFactorSelect: (factorId: string) => void;
  onSlotClick: (slotId: string) => void;
  onComplexSlotClick: (complexSlotId: string) => void;
}

// Update component to accept and pass new props
export function GameCanvas({
  gameState,
  onFactorSelect,
  onSlotClick,
  onComplexSlotClick,
}: GameCanvasProps): React.ReactElement {
  return (
    <div
      style={{
        position: 'relative',
        width: GAME_CANVAS.width,
        height: GAME_CANVAS.height,
        backgroundColor: COLORS.panelBackgroundLocked,
        overflow: 'hidden',
        fontFamily: 'system-ui, -apple-system, sans-serif',
      }}
    >
      <GameHUD
        thrombinMeter={gameState.thrombinMeter}
        currentMessage={gameState.currentMessage}
        isError={gameState.isError}
        phase={gameState.phase}
      />

      {PANEL_CONFIGS.map((config) => (
        <SurfacePanel
          key={config.surface}
          config={config}
          slots={gameState.slots}
          complexSlots={gameState.complexSlots}
          gameState={gameState}
          onSlotClick={onSlotClick}
          onComplexSlotClick={onComplexSlotClick}
        />
      ))}

      <FactorPalette
        availableFactors={gameState.availableFactors}
        selectedFactorId={gameState.selectedFactorId}
        onFactorClick={onFactorSelect}
      />

      <CirculationTray
        circulationFactors={gameState.circulationFactors}
        selectedFactorId={gameState.selectedFactorId}
        gameState={gameState}
        onFactorClick={onFactorSelect}
      />
    </div>
  );
}
```

**Step 2: Commit**

```bash
git add components/game/GameCanvas.tsx
git commit -m "feat(components): add CirculationTray to GameCanvas"
```

---

## Task 9: Update Game Page

**Files:**
- Modify: `app/game/page.tsx`

**Step 1: Wire up new attemptComplexPlace action**

```typescript
// Update destructuring
const { state, selectFactor, deselectFactor, attemptPlace, attemptComplexPlace, resetGame } = useGameState();

// Update GameCanvas props
<GameCanvas
  gameState={state}
  onFactorSelect={selectFactor}
  onSlotClick={attemptPlace}
  onComplexSlotClick={attemptComplexPlace}
/>
```

**Step 2: Commit**

```bash
git add app/game/page.tsx
git commit -m "feat(app): wire up complex slot placement"
```

---

## Task 10: Update GameCompleteModal

**Files:**
- Modify: `components/game/GameCompleteModal.tsx`

**Step 1: Update victory message for full cascade**

Update the educational content:

```typescript
{/* Summary */}
<div
  style={{
    fontSize: 14,
    color: COLORS.textSecondary,
    lineHeight: 1.6,
    marginBottom: 24,
  }}
>
  <p style={{ marginBottom: 12 }}>
    You completed the full <strong>cell-based coagulation cascade</strong>!
  </p>
  <p style={{ marginBottom: 12 }}>
    <strong>What you learned:</strong>
  </p>
  <ul
    style={{
      textAlign: 'left',
      paddingLeft: 24,
      marginBottom: 12,
    }}
  >
    <li><strong>Initiation:</strong> TF+VIIa generates FXa and FIXa on TF-bearing cells</li>
    <li><strong>Starter thrombin:</strong> FXa + trace Va produces small thrombin (primes platelets)</li>
    <li><strong>Amplification:</strong> Thrombin activates FV→FVa and FVIII→FVIIIa</li>
    <li><strong>Tenase:</strong> FIXa + FVIIIa generates abundant FXa on activated platelet</li>
    <li><strong>Prothrombinase:</strong> FXa + FVa produces the thrombin burst</li>
  </ul>
  <p>
    <strong>Key insight:</strong> Surface segregation and enzyme-cofactor complexes
    amplify the signal from tiny initiation to massive thrombin output.
  </p>
</div>
```

**Step 2: Update title**

```typescript
<h2
  style={{
    fontSize: 28,
    fontWeight: 700,
    color: '#22C55E',
    marginBottom: 16,
  }}
>
  Thrombin Burst Achieved!
</h2>
```

**Step 3: Commit**

```bash
git add components/game/GameCompleteModal.tsx
git commit -m "feat(components): update victory modal for full cascade"
```

---

## Task 11: Build Verification

**Files:**
- None (verification only)

**Step 1: Run full build**

Run: `npm run build 2>&1 | tail -30`

Expected: Build succeeds with no errors.

**Step 2: Fix any type errors**

If errors occur, fix them and re-run build until it passes.

**Step 3: Manual test checklist**

- [ ] Game loads at `/game`
- [ ] FIX slot visible on TF-cell panel
- [ ] Place FX → FXa (no thrombin increase)
- [ ] Place FIX → FIXa appears in Circulation tray (grayed)
- [ ] Place FII → THR (thrombin hits 30%, platelet unlocks)
- [ ] Place FV → FVa
- [ ] Place FVIII → FVIIIa
- [ ] Activated Platelet unlocks, cofactors auto-fill complex slots
- [ ] FIXa in Circulation becomes clickable
- [ ] Dock FIXa into Tenase enzyme slot
- [ ] Tenase complete → FXa-tenase appears in Circulation
- [ ] Dock FXa-tenase into Prothrombinase enzyme slot
- [ ] Thrombin hits 100%, victory modal appears
- [ ] Victory modal shows full cascade summary
- [ ] Play Again resets game

**Step 4: Final commit (if any fixes needed)**

```bash
git add -A
git commit -m "fix: address build verification issues"
```

---

## Summary

| Task | Description |
|------|-------------|
| 1 | Update types with ComplexSlot and circulation |
| 2 | Add FIX factor, update thrombin contributions |
| 3 | Add complex slots config, FIX slot, enable activated platelet |
| 4 | Update validation for complexes and victory |
| 5 | Update reducer with complex placement and auto-transfer |
| 6 | Create CirculationTray component |
| 7 | Update SurfacePanel for complex slots |
| 8 | Update GameCanvas with CirculationTray |
| 9 | Wire up complex placement in game page |
| 10 | Update victory modal for full cascade |
| 11 | Build verification and manual testing |
